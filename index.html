<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VATSIM</title>

  <script src='js/mapbox-gl.js'></script>
  <link href='css/mapbox-gl.css' rel='stylesheet' />

  <link rel="stylesheet" href="css/main.css" />
</head>
<body>
  <header class="main-header">
    <h1>VATSIM Live</h1>
    <p>Last Update: <span id="last-update"></span> <a id="reload" href="#">update now</a></p>
  </header>
  <div id="map"></div>
  <p>
    <h2>Credits</h2>
    <p>Airport by Aldric Rodríguez Iborra from the Noun Project</p>
    <p>Airplane by Aldric Rodríguez Iborra from the Noun Project</p>
    <p>Airplane by Michal Beno from the Noun Project</p>
  </p>

  <script src="js/leaflet.js"></script>
  <script src="js/leaflet.restoreview.js"></script>
  <script src="js/fetch.js"></script>
  <script>
  var lastUpdate = undefined;
  (function(){
    mapboxgl.accessToken = 'pk.eyJ1IjoicmF1YmVyZGFuaWVsIiwiYSI6Il9tWG1vc1EifQ.Ey1SqF39V3R2hk-nF2pcDg';

    var markers = {};
    var currentAircraftIds = [];
    var currentAircrafts = [];

    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/rauberdaniel/ciuc6yrzm002s2ho885r9u5dq',
        minZoom: 1,
        zoom: 1
    });

    var fetchData = function() {
      fetch('pilots.json', {cache: 'reload'}).then(function(res){
        return res.json();
      }).then(function(json){
        lastUpdate = (json.timestamp) * 1000;
        document.getElementById('last-update').innerHTML = new Date(lastUpdate);
        currentAircrafts = json.data;
        updateAircrafts(json.data);
      });
    };

    var updateAircrafts = function(aircrafts) {
      var realUpdate = false;
      if(aircrafts) { realUpdate = true; }
      aircrafts = aircrafts || currentAircrafts;
      var aircraftsAdded = [];
      var aircraftsRemoved = [];
      currentAircraftIds = [];
      aircrafts.forEach(function(aircraft){
        currentAircraftIds.push(aircraft.cid);
        if(markers[aircraft.cid]) {
          updateAircraftMarker(markers[aircraft.cid], aircraft, realUpdate);
        } else {
          aircraftsAdded.push(aircraft.cid);
          addAircraftMarker(markers, aircraft, map)
        }
      });
      for(id in markers) {
        if(currentAircraftIds.indexOf(id) < 0) {
          aircraftsRemoved.push(id);
          removeAircraftMarker(markers, id);
        }
      };
      //console.log('added', aircraftsAdded);
      //console.log('removed', aircraftsRemoved);
    }

    updateATC(map);
    fetchData();
    setInterval(updateAircrafts, 500);

    document.querySelector('#reload').addEventListener('click', function(e){
      e.preventDefault();
      fetchData();
    });
  })();

  /*

  fetchData();
  setInterval(fetchData, 60*1000);



  */

  function updateAircraftMarker(marker, aircraft, newData) {
    var lat = aircraft.latitude + getYDelta(aircraft);
    var lon = aircraft.longitude + getXDelta(aircraft);

    // make sure we don’t run over the borders
    lat = Math.min(90, Math.max(-90, lat));
    lon = Math.min(180, Math.max(-180, lon));

    marker.setLngLat([lon, lat]);
    // set marker heading
    if(newData) {
      var plane = marker['_element'].querySelector('div');
      // remove old heading
      var oldHeading = plane.className.match(/hdg-[0-9]{1,3}/i);
      if(oldHeading) {
        plane.classList.remove(oldHeading[0]);
      }
      plane.classList.add('hdg-'+getAircraftHeading(aircraft));
    }
  }

  function addAircraftMarker(markers, aircraft, map) {
    markers[aircraft.cid] = new mapboxgl.Marker(getPlaneMarker(aircraft), {offset: [-15, -15]}).setLngLat([aircraft.longitude, aircraft.latitude]);
    markers[aircraft.cid].addTo(map);
  }

  function removeAircraftMarker(markers, id) {
    markers[id].remove();
    delete markers[id];
  }


  function updateATC(map) {
    fetch('atc.json', {cache: 'reload'}).then(function(res){
      return res.json();
    }).then(function(data){
      data.data.forEach(function(atc){
        new mapboxgl.Marker(getATCMarker(atc), {offset: [-12, -12]}).setLngLat([atc.longitude, atc.latitude]).addTo(map);
      });
    })
  }

  function getATCMarker(atc) {
    var el = document.createElement('div');
    el.classList.add('atc-marker');
    if(/_TWR$/.test(atc.callsign)) { el.classList.add('tower-marker'); }
    if(/_GND$/.test(atc.callsign)) { el.classList.add('ground-marker'); }
    if(/_ATIS$/.test(atc.callsign)) { el.classList.add('atis-marker'); }
    return el;
  }

  function getPlaneMarker(aircraft) {
    var el = document.createElement('div');
    el.classList.add('plane-marker');
    var plane = document.createElement('div');
    plane.classList.add('hdg-'+getAircraftHeading(aircraft));
    plane.classList.add('plane-'+getAircraftClass(aircraft));
    el.appendChild(plane);
    return el;
  }

  function getAircraftHeading(aircraft) {
    return (Math.round(aircraft.heading/15) * 15) % 360;
  }

  function getAircraftClass(aircraft) {
    if(  /^H\//i.test(aircraft.planned_aircraft) ) { return 'heavy'; }
    if(  /(C172|B58)/i.test(aircraft.planned_aircraft) ) { return 'small'; }
    return 'basic';
  }

  function getTitle(pilot) {
    return pilot.callsign + " (" + pilot['planned_aircraft'] + ")";
  }

  function getTimeDelta() {
    // returns seconds since last update of data
    return (Date.now() - lastUpdate) / 1000;
  }

  function getXDelta(aircraft) {
    return getXSpeed(aircraft) * getTimeDelta();
  }

  function getYDelta(aircraft) {
    return getYSpeed(aircraft) * getTimeDelta();
  }

  function getXSpeed(aircraft) {
    var earthcircumfence = 40080000;
    var degreeDistance = 1/360 * earthcircumfence * Math.cos(toRad(aircraft.latitude)); // distance of 1 degree in m
    degreeDistance = Math.max(degreeDistance, 1) // make sure it does not get zero
    var xGroundSpeed = toMperS(aircraft.groundspeed) * Math.sin(toRad(aircraft.heading));
    return xGroundSpeed / degreeDistance;
  }

  function getYSpeed(aircraft) {
    var degreeDistance = 111000; // distance of 1 degree in m
    var yGroundSpeed = toMperS(aircraft.groundspeed) * Math.cos(toRad(aircraft.heading));
    return yGroundSpeed / degreeDistance;
  }

  function toRad(grad) {
    return grad/180*Math.PI;
  }

  function toMperS(groundspeed) {
    return groundspeed * 0.51444;
  }
  </script>
</body>
</html>
